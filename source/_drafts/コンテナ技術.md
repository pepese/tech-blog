---
title: コンテナ技術
tags:
- コンテナ
id: container-basics
---

コンテナを実現している技術についてまとめる。

- chroot
    - ルートディレクトリを変更する
- namespace
    - OS リソースの隔離
    - プロセスをグループ化して他のリソースと隔離
    - 新たな nemespace で PID 1 のプロセスとか作れる
- cgroup
    - ホストの物理リソースに対する制限
    - グループ化したプロセス対するリソース制限
- capability
    - root 権限をプロセスやファイルに割り当てる
- clone
- pivot_root
- mount

- 参考
    - http://dojineko.hateblo.jp/entry/2017/05/04/180455
    - https://inokara.hateblo.jp/entry/2017/04/30/092304
    - https://medium.com/@11Takanori/%E3%82%B3%E3%83%B3%E3%83%86%E3%83%8A%E3%81%AE%E3%81%97%E3%81%8F%E3%81%BF-ac6f4a83eda4
    - https://qiita.com/wellflat/items/7d62f2a63e9fcddb31cc

# chroot

`Change Root` の名前の通り、指定したプロセスとその配下の子プロセスに対して、仮想的にルートディレクトリを変更する機能。  
例えば `bash` を起動するときに `chroot` で `/var/www/virtual_home/` がルートディレクトリに見えるように指定すると、起動した `bash` 上で `cd /` を実行したときに 実際にアクセスするのは `/var/www/virtual_home/` というようにすることができる。  
言い換えると隔離された環境から `/var/www/virtual_home/` より上のディレクトリは見えなくなります。  
ルートディレクトリが変わるということは、`chroot` 後にアプリを起動するためのライブラリなどの資産は全て `chroot` 後のディレクトリ配下に揃っている必要がある点に注意が必要。

```
$ chroot [オプション] [変更先ルートディレクトリ] [実行するコマンド]
```

|オプション|説明|
|---|---|
|--userspec=【ユーザ】:【グループ】|指定したユーザーおよびグループ（ID または名前）で実行する|
|---groups=【グループのリスト】|「g1,g2,..,gN 形式で追加のグループを指定します」らしい|
|--help|ヘルプを表示する|
|--version|バージョン情報を表示する|

`chroot /usr` を実行したところ `/usr` がルートディレクトリになる。
この状態でコマンドを実行しても `/usr/bin` に存在するため、コマンドを見つけることができない。
ルードディレクトリの変更を解除したい場合は `exit` を実行する。

`chroot [ルートディレクトリ] [コマンド]` を実行すると、
1. ルートディレクトリが変更される
2. 指定したコマンドが実行される
3. ルートディレクトリの変更が解除される
が一気に行われる。

# namespace

`Linux` の `namespace` はプロセスの名前空間を定義する。  
`namespace` を利用すると任意のプロセスを、大本の環境から仮想的に隔離した状態で実行することができる。  
例えば `bash` を initプロセス(PID:1) として起動し子プロセスをぽこぽこ起動するということができる。  
`namespace` が隔離できるのは PID だけでなく、ユーザーID、グループID、マウントポイントなど他にもありオプションで指定可能。

`unshare` コマンドで namespace を切り替えることができる。